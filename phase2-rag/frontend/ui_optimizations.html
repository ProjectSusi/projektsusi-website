
<!-- Enhanced UI Performance Optimizations -->
<script>
// UI Performance Optimizer
class UIPerformanceOptimizer {
    constructor() {
        this.loadStartTime = performance.now();
        this.metrics = {
            pageLoadTime: 0,
            firstContentfulPaint: 0,
            interactionTime: 0
        };
        this.optimizationsActive = true;
        
        this.init();
    }
    
    init() {
        // Optimize page loading
        this.optimizePageLoad();
        
        // Implement virtual scrolling for large lists
        this.setupVirtualScrolling();
        
        // Add performance monitoring
        this.startPerformanceMonitoring();
        
        // Optimize form interactions
        this.optimizeFormHandling();
    }
    
    optimizePageLoad() {
        // Preload critical resources
        const criticalResources = [
            '/static/dashboard.html',
            '/health',
            '/ui'
        ];
        
        criticalResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = resource;
            document.head.appendChild(link);
        });
        
        // Lazy load non-critical components
        this.setupLazyLoading();
    }
    
    setupLazyLoading() {
        // Intersection Observer for lazy loading
        const lazyLoadObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    if (element.dataset.src) {
                        element.src = element.dataset.src;
                        element.classList.remove('lazy');
                        observer.unobserve(element);
                    }
                }
            });
        });
        
        // Observe all lazy elements
        document.querySelectorAll('.lazy').forEach(el => {
            lazyLoadObserver.observe(el);
        });
    }
    
    setupVirtualScrolling() {
        // Virtual scrolling for large result lists
        const resultContainers = document.querySelectorAll('.result-list');
        
        resultContainers.forEach(container => {
            this.addVirtualScrolling(container);
        });
    }
    
    addVirtualScrolling(container) {
        // Simple virtual scrolling implementation
        let visibleItems = [];
        const itemHeight = 60; // Estimated item height
        const containerHeight = container.clientHeight;
        const maxVisible = Math.ceil(containerHeight / itemHeight) + 2; // Buffer
        
        container.addEventListener('scroll', () => {
            const scrollTop = container.scrollTop;
            const startIndex = Math.floor(scrollTop / itemHeight);
            const endIndex = Math.min(startIndex + maxVisible, container.children.length);
            
            // Hide non-visible items
            for (let i = 0; i < container.children.length; i++) {
                const item = container.children[i];
                if (i >= startIndex && i <= endIndex) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            }
        });
    }
    
    optimizeFormHandling() {
        // Debounce form inputs
        const inputs = document.querySelectorAll('input[type="text"], textarea');
        
        inputs.forEach(input => {
            let timeout;
            input.addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    this.handleOptimizedInput(e.target);
                }, 300); // 300ms debounce
            });
        });
    }
    
    handleOptimizedInput(input) {
        // Optimized input handling with caching
        const value = input.value.trim();
        if (value.length > 2) {
            // Trigger optimized search/processing
            this.triggerOptimizedQuery(value);
        }
    }
    
    async triggerOptimizedQuery(query) {
        // Enhanced query with performance optimization
        const startTime = performance.now();
        
        try {
            const response = await fetch('/api/v1/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    optimization_level: 'phase2',
                    ui_optimized: true
                })
            });
            
            const result = await response.json();
            const queryTime = performance.now() - startTime;
            
            // Update UI with optimized rendering
            this.renderOptimizedResults(result, queryTime);
            
        } catch (error) {
            console.error('Optimized query failed:', error);
        }
    }
    
    renderOptimizedResults(results, queryTime) {
        // Optimized result rendering with progressive enhancement
        const container = document.getElementById('results-container') || document.body;
        
        // Use document fragment for efficient DOM manipulation
        const fragment = document.createDocumentFragment();
        
        if (results.answer) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'optimized-result';
            resultDiv.innerHTML = `
                <div class="result-content">${results.answer}</div>
                <div class="performance-info">
                    Query processed in ${queryTime.toFixed(2)}ms (Phase 2 Optimized âš¡)
                </div>
            `;
            fragment.appendChild(resultDiv);
        }
        
        // Batch DOM update
        requestAnimationFrame(() => {
            container.appendChild(fragment);
        });
    }
    
    startPerformanceMonitoring() {
        // Monitor Core Web Vitals
        if ('web-vital' in window) {
            window.webVitals.getCLS(this.recordMetric.bind(this));
            window.webVitals.getFID(this.recordMetric.bind(this));
            window.webVitals.getLCP(this.recordMetric.bind(this));
        }
        
        // Monitor custom performance metrics
        setInterval(() => {
            this.recordCustomMetrics();
        }, 5000); // Every 5 seconds
    }
    
    recordMetric(metric) {
        console.log('Performance metric:', metric.name, metric.value);
        // Send to analytics endpoint
        this.sendToAnalytics({
            type: 'performance',
            metric: metric.name,
            value: metric.value,
            timestamp: Date.now()
        });
    }
    
    recordCustomMetrics() {
        const metrics = {
            memoryUsage: performance.memory ? performance.memory.usedJSHeapSize : 0,
            timing: performance.timing,
            optimizationsActive: this.optimizationsActive,
            phase: 'phase2'
        };
        
        this.sendToAnalytics({
            type: 'custom_performance',
            metrics: metrics,
            timestamp: Date.now()
        });
    }
    
    async sendToAnalytics(data) {
        try {
            // Send to local analytics endpoint
            await fetch('/api/v1/optimization/analytics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        } catch (error) {
            console.debug('Analytics endpoint not available:', error);
        }
    }
    
    getStats() {
        return {
            optimizationsActive: this.optimizationsActive,
            loadTime: performance.now() - this.loadStartTime,
            metrics: this.metrics,
            phase: 'phase2',
            features: [
                'lazy_loading',
                'virtual_scrolling', 
                'debounced_inputs',
                'performance_monitoring',
                'optimized_rendering'
            ]
        };
    }
}

// Initialize UI optimizer when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.uiOptimizer = new UIPerformanceOptimizer();
    });
} else {
    window.uiOptimizer = new UIPerformanceOptimizer();
}
</script>

<style>
/* Performance-optimized CSS */
.optimized-result {
    animation: fadeInUp 0.3s ease-out;
    transform: translateZ(0); /* Enable hardware acceleration */
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translate3d(0, 20px, 0);
    }
    to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
    }
}

.lazy {
    opacity: 0;
    transition: opacity 0.3s;
}

.lazy.loaded {
    opacity: 1;
}

.result-list {
    contain: layout style paint;
    will-change: scroll-position;
}

.performance-info {
    font-size: 12px;
    color: #059669;
    margin-top: 10px;
    font-weight: 600;
}
</style>
